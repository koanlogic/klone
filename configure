#!/bin/sh
#
# $Id: configure,v 1.11 2005/09/29 19:24:39 tho Exp $

export makl_debug=1

# Be sure MAKL_DIR is there.
# If not found assume MaKL has been embedded in the package.
if [ -z "${MAKL_DIR}" ]
then
    if [ -d `pwd`/makl ]
    then
        export MAKL_DIR=`pwd`/makl
    else
        echo "MaKL MUST be installed and MAKL_DIR set in the environment"
        exit 1
    fi
fi

# MaKL preamble
. ${MAKL_DIR}/cf/makl.init

# Preprocess arguments
makl_args_init "$@"

# Custom arguments ...
makl_args_def   "enable_debug"      "" ""   "enables debugging"
makl_args_def   "enable_profile"    "" ""   "enables profiling"
makl_args_def   "enable_sup_fs"     "" ""   "enables filesystem web access"
# ... and their handlers
_makl_enable_debug () { makl_add_var_mk "CFLAGS" "-g" ; }
_makl_enable_profile () { makl_add_var_mk "CFLAGS" "-pg -a" ; }
_makl_enable_sub_fs () { makl_add_var_h "ENABLE_SUP_FS" ; }

# General settings
makl_pkg_name           "klone"
makl_pkg_version

case `makl_os_name` in

    *-*-mingw*)
        makl_set_var_h      "OS_WIN"
        makl_add_var_mk     "LIBS"      "-lwsock32 -L/c/WINDOWS" 
        ;;

    freebsd4*)
        makl_set_var_h      "OS_UNIX"
        makl_add_var_mk     "CFLAGS" "-pthread"
        makl_require        "lib" "crypto"
        ;;

    *)
        makl_set_var_h      "OS_UNIX"
        # the following is a hack ... [FIXME]
        makl_set_var_h      "HAVE_STDINT"
        makl_require        "lib"       "pthread"
        makl_require        "lib"       "crypto"
        ;;
esac

makl_add_var_mk "CFLAGS" "-W -Wall -Wpointer-arith -Wno-uninitialized"
makl_add_var_mk "CFLAGS" "-Wreturn-type -Wcast-qual -Wwrite-strings"
makl_add_var_mk "CFLAGS" "-Wswitch -Wshadow"
makl_add_var_mk "CFLAGS" "-DHAVE_CONF_H"

# Binary dependencies
makl_feature_x          "doxygen"

# Library dependencies
makl_optional           "1"     "lib"       "z"

# Function dependencies
makl_checktype          "pid_t"     "<sys/types.h>" 
makl_checkfunc          "getpid"
makl_checkfunc          "unlink"
makl_checkfunc          "strtok_r"
makl_checkfunc          "syslog"
makl_func_strerror_r

# Handle command-line arguments
makl_args_handle "$@"

# Set HAVE_OPENSSL, OPENSSL_CFLAGS and OPENSSL_LDFLAGS
if [ -n `makl_get_var_mk "HAVE_LIBCRYPTO"` ]; then

    makl_set_var "HAVE_OPENSSL"
    makl_set_var_mk "OPENSSL_LDFLAGS" \
        "-lssl `makl_get_var_mk LIBCRYPTO_LDFLAGS`"
    makl_set_var_mk "OPENSSL_CFLAGS" \
        "`makl_get_var_mk LIBCRYPTO_CFLAGS`"
    # now remove dirty bits 
    makl_unset_var_mk "HAVE_LIBCRYPTO"
    makl_unset_var_mk "LIBCRYPTO_LDFLAGS"
    makl_unset_var_mk "LIBCRYPTO_CFLAGS"
fi

# Set server model depending on OS_{UNIX,WIN}
if [ -n `makl_get_var_mk "OS_UNIX"` ]; then
    makl_set_var_h "CONFIG_SERVER_MODEL" "CONFIG_SERVER_FORK" 1
else
    makl_set_var_h "CONFIG_SERVER_MODEL" "CONFIG_SERVER_THREAD" 1
fi

. ${MAKL_DIR}/cf/makl.term
